---
- name: publish CloudFormation template
  hosts: localhost
  connection: local
  gather_facts: no
  vars:
    bucket: "conjur-ci-public"

  tasks:
    - name: download cft
      get_url:
        url: https://raw.githubusercontent.com/cyberark/conjur/master/aws/cloudformation/conjur.yml      
        dest: /ansible/conjur.yml

    - name: update AMI ID
      lineinfile:
        path: /ansible/conjur.yml
        state: present
        regexp: AWS::EC2::Image::Id
        insertafter: AWS::EC2::Image::Id
        line: "    Default: {{ ami_id }}"

    - name: write template to S3
      s3:
        bucket: "{{ bucket }}"
        object: conjur.yml
        src: /ansible/conjur.yml
        mode: put
